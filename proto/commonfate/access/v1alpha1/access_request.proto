syntax = "proto3";

package commonfate.access.v1alpha1;

import "commonfate/control/attest/v1alpha1/attestation.proto";
import "commonfate/access/v1alpha1/user.proto";
import "commonfate/authz/v1alpha1/entity.proto";
import "commonfate/access/v1alpha1/named_uid.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";

// TheAccess Request API.
//
// When operating on Access Requests, Common Fate will automatically attempt to apply the action (Approve/Close/Revoke etc)
// to each Grant associated with the Access Request. Warnings will be returned if the operation fails for any grants.
service AccessRequestService {
    rpc QueryAccessRequests(QueryAccessRequestsRequest) returns (QueryAccessRequestsResponse) {}
    rpc GetAccessRequest(GetAccessRequestRequest) returns (GetAccessRequestResponse) {}

    // Approving an Access Request will attempt to approve all of the Grants associated with the request.
    //
    // If the caller is not permitted to approve particular grants, warnings will be returned.
    rpc ApproveAccessRequest(ApproveAccessRequestRequest) returns (ApproveAccessRequestResponse) {}

    // Closing an Access Request will make it no longer reviewable and will deactivate any Grants associated with the request.
    rpc CloseAccessRequest(CloseAccessRequestRequest) returns (CloseAccessRequestResponse) {}
}

message QueryAccessRequestsRequest {
    // The token for the next page.
    string page_token = 10;
}

message QueryAccessRequestsResponse {
  repeated AccessRequest access_requests = 1;
  string next_page_token = 2;
}

message GetAccessRequestRequest {
  // The ID of the Access Request.
  string id = 1;
}

message GetAccessRequestResponse {
  AccessRequest access_request = 1;
}


// A request to be given entitlements allowing <Action> to be performed on <Resource>.
//
// For example, if the action is 'Admin', and the resource is AWS::Account::123456789012,
// This request is for entitlements allowing Admin access to the account 123456789012.
message AccessRequest {
    // The ID of the Access Request.
    string id = 1;

    // Batch ID of the Access Request. Access Requests created in the same 
    // API call have the same Batch ID.
    string batch_id = 2;

    // The grants under consideration for access.
    repeated Grant grants = 3;

    // An access request is reviewable if one or more Grants in the request
    // requires a manual review.
    bool reviewable = 4;

    // True if the Access Request already existed and wasn't created by the API call.
    bool existing = 5;

    // The timestamp that the request was created at.
    google.protobuf.Timestamp created_at = 8;
}

message Grant {
    // The ID of the Grant.
    string id = 1;

    // The resource being requested.
    NamedUID target = 3;

    // The role being requested, such as "View" or "Admin".
    NamedUID role = 4;

    // The user or service account that requested the access.
    //
    // If a service account requested access, the 'name' and 'email' may be empty.
    User principal = 5;

    // The status of the Grant.
    GrantStatus status = 6;

    // Users designated as reviewers for the Grant.
    repeated User reviewers = 7;

    // For active grants, the time that the access is due to expire.
    google.protobuf.Timestamp expires_at = 8;

    // Diagnostic warnings about the Grant: for example if there are no reviewers assigned
    // or if the grant is due to expiry shortly.
    repeated string warnings = 9;

    // Audit log events associated with the Grant.
    repeated GrantEvent events = 10;
}

enum GrantAction {
  GRANT_ACTION_UNSPECIFIED = 0;

  // Access was requested.
  GRANT_ACTION_REQUESTED = 1;


  // Access was approved.
  GRANT_ACTION_APPROVED = 2;

  // Access was provisioned.
  GRANT_ACTION_PROVISIONED = 3;

  // The grant was closed.
  GRANT_ACTION_CLOSED = 4;

  // An error occurred.
  GRANT_ACTION_ERROR = 5;

  // Access was deprovisioned.
  GRANT_ACTION_DEPROVISIONED = 6;
}

// User facing events relating to the Grant lifecycle, such as the Grant being approved and
// activated. Note that these aren't the same as the audit trail events emitted internally by
// Common Fate, which may contain additional information such as IP addresses of actors.
message GrantEvent {
  // the action which occurred
  GrantAction action = 1;
  // the actor which performed the action.
  User actor = 2;
  // the timestamp the action occurred at.
  google.protobuf.Timestamp occurred_at = 3;
  // a human-friendly message describing the action.
  string message = 4;
}

enum GrantStatus {
    GRANT_STATUS_UNSPECIFIED = 0;

    // Awaiting a manual review.
    GRANT_STATUS_PENDING_APPROVAL = 1;

    // Approved and awaiting activation by the principal.
    GRANT_STATUS_APPROVED = 2;
    // The grant to the entitlement is currently active. 
    GRANT_STATUS_ACTIVE = 3;

    // No longer active. Grants may be inactive due to several reasons, such as:
    // - the grant was cancelled by the user
    // - the grant was revoked by an administrator
    // - the grant has expired
    GRANT_STATUS_INACTIVE = 4;

    // The Grant encountered a fatal error.
    GRANT_STATUS_ERROR = 5;
}

message RevokeAccessRequestRequest {
  // The ID of the Access Request.
  string id = 1;
}

message RevokeAccessRequestResponse {
  Warnings warnings = 1;
}


message ApproveAccessRequestRequest {
  // The ID of the Access Request.
  string id = 1;
}

message ApproveAccessRequestResponse {
  Warnings warnings = 1;
}

message CloseAccessRequestRequest {
  // The ID of the Access Request.
  string id = 1;
}

message CloseAccessRequestResponse {
  Warnings warnings = 1;
}

message Warnings {
  // Grants that were unable to be acted upon because of a permissions error.
  repeated Grant grants_permission_denied = 1;

  // Grants that were unable to be acted upon because they were in an invalid state.
  repeated Grant grants_invalid_status = 2;
}

syntax = "proto3";

package commonfate.control.log.v1alpha1;

import "google/protobuf/timestamp.proto";

import "commonfate/authz/v1alpha1/request.proto";
import "commonfate/authz/v1alpha1/evaluation.proto";
import "commonfate/authz/v1alpha1/policy.proto";
import "commonfate/authz/v1alpha1/read_only.proto";
import "commonfate/entity/v1alpha1/entity.proto";
import "commonfate/entity/v1alpha1/eid.proto";
import "google/protobuf/duration.proto";

// EvalService is the API for auditing authorization evaluations made by authz.
service EvaluationService {
    // Query for historical authorization evaluations.
    rpc QueryEvaluations(QueryEvaluationsRequest) returns (QueryEvaluationsResponse) {
        option(commonfate.authz.v1alpha1.read_only) = true;
    }

    // Returns an authorization evaluation by a particular ID.
    rpc GetEvaluation(GetEvaluationRequest) returns (GetEvaluationResponse) {
        option(commonfate.authz.v1alpha1.read_only) = true;
    }

    // Fetches debug information about the evaluation of a particular decision
    rpc DebugEvaluation(DebugEvaluationRequest) returns (DebugEvaluationResponse) {
        option(commonfate.authz.v1alpha1.read_only) = true;
    }
}

message QueryEvaluationsRequest {
    // The token for the next page.
    string page_token = 1;

    // If provided, returns evaluations which occurred after this time.
    optional google.protobuf.Timestamp start_time = 2;

    // If provided, returns evaluations which occurred before this time.
    optional google.protobuf.Timestamp end_time = 3;

    // If provided, only evaluations matching the provided tags will be returned.
    repeated commonfate.authz.v1alpha1.Tag matching_tags = 4;

    // If provided, filters for evaluations with the matching principal
    commonfate.entity.v1alpha1.EID principal = 5;

    // If provided, filters for evaluations with the matching action
    commonfate.entity.v1alpha1.EID action = 6;

    // If provided, filters for evaluations with the matching resource.
    commonfate.entity.v1alpha1.EID resource = 7;

    // If provided, filters for evaluations with the specified decision.
    optional commonfate.authz.v1alpha1.Decision decision = 8;
}

message QueryEvaluationsResponse {
    repeated commonfate.authz.v1alpha1.Evaluation evaluations = 1;
    string next_page_token = 2;
}


message GetEvaluationRequest {
    // The authorization evaluation ID.
    string id = 1;
}

message GetEvaluationResponse {
    commonfate.authz.v1alpha1.Evaluation evaluation = 1;
}

message DebugEvaluationRequest {
    string id = 1;
}

message DebugEvaluationResponse {
    commonfate.authz.v1alpha1.DebugEvaluation debug_evaluation = 1;
}
